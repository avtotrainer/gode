<!doctype html>
<html lang="ka">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ᲞᲝᲠᲢᲤᲝᲚᲘᲝᲔᲑᲘ</title>
    <meta
      name="description"
      content="საზაფხულო სკოლის მონაწილეთა პორტფოლიო-გვერდების სარჩევი QR კოდებით."
    />
    <link rel="stylesheet" href="assets/css/style.css" />
    <link rel="icon" href="favicon.ico" />
    <meta name="theme-color" content="#0ea5e9" />
  </head>
  <body>
    <header>
      <div class="container">
        <nav>
          <div class="logo">📚 პორტფოლიოების სარჩევი</div>
          <div style="color: #9aa6bb">საზაფხულო სკოლა</div>
        </nav>
      </div>
    </header>

    <main>
      <div class="container">
        <h1>სტუდენტების პორტფოლიოები</h1>
        <p class="lead">
          ქვემოთ ნახავთ ყველა შექმნილი ერთგვერდიანი საიტის ბმულს. მოძებნე
          სახელი/ელ-ფოსტა/ბმული, და სკანირებისთვის გამოიყენე QR.
        </p>

        <!-- Tools -->
        <div class="tools">
          <label class="search" aria-label="ძებნა">
            🔎
            <input
              id="q"
              placeholder="ძებნა: სახელი, გვარი, ელფოსტა, github…"
            />
            <button class="btn ghost" id="clear" type="button">
              გასუფთავება
            </button>
          </label>
          <button class="btn" id="copyCsv" type="button">CSV ექსპორტი</button>
        </div>

        <!-- Cards (dynamic) -->
        <div class="grid" id="list" aria-live="polite"></div>
      </div>
    </main>

    <footer>
      <div class="container">
        <div class="foot">
          <span
            >© <span id="y"></span> საზაფხულო სკოლა — პორტფოლიოების
            სარჩევი</span
          >
          <span class="muted">განახლდა: <span id="lm"></span></span>
        </div>
      </div>
    </footer>

    <script>
      // წელი/ბოლო ცვლილება
      document.getElementById("y").textContent = new Date().getFullYear();
      document.getElementById("lm").textContent = new Date(
        document.lastModified,
      ).toLocaleDateString("ka-GE");

      // ჩაშენებული სია (fallback), თუ sites.json ვერ ჩაიტვირთა
      const BUILTIN = [
        {
          name: "ᲐᲜᲐᲜᲝ ᲙᲐᲮᲐᲫᲔ",
          email: "anano864@din.ge",
          url: "https://avtotrainer.github.io/anano",
          github: "https://github.com/avtotrainer/anano",
          tags: "ᲕᲔᲑ · Linux",
        },
        {
          name: "ᲐᲜᲐᲡᲢᲐᲡᲘᲐ ᲨᲐᲠᲐᲨᲘᲫᲔ",
          email: "anastasia9440@din.ge",
          url: "https://avtotrainer.github.io/taso",
          github: "https://github.com/avtotrainer/taso",
          tags: "GitHub Pages",
        },
        {
          name: "ᲑᲐᲩᲘ ᲯᲘᲜᲭᲐᲠᲐᲫᲔ",
          email: "bachi096@din.ge",
          url: "https://avtotrainer.github.io/bachi",
          github: "https://github.com/avtotrainer/bachi/",
          tags: "Linux · Bash",
        },
        {
          name: "ᲒᲘᲒᲘ ᲪᲔᲪᲮᲚᲐᲫᲔ",
          email: "gigi240@din.ge",
          url: "https://avtotrainer.github.io/gigi",
          github: "https://github.com/avtotrainer/gigi",
          tags: "სტატიკური საიტი",
        },
        {
          name: "ᲒᲘᲝᲠᲒᲘ ᲑᲔᲠᲘᲫᲔ",
          email: "giorgi@din.ge",
          url: "https://avtotrainer.github.io/gber",
          github: "https://github.com/avtotrainer/gber",
          tags: "WSLg · Git",
        },
        {
          name: "ᲒᲘᲝᲠᲒᲘ ᲗᲣᲠᲛᲐᲜᲘᲫᲔ",
          email: "giorgi030@din.ge",
          url: "https://avtotrainer.github.io/gtur",
          github: "https://github.com/avtotrainer/gtur",
          tags: "Linux · Pages",
        },
      ];

      // cards renderer
      const list = document.getElementById("list");
      function utm(url) {
        try {
          const u = new URL(url);
          if (u.protocol.startsWith("http")) {
            u.searchParams.set("utm_source", "index");
            u.searchParams.set("utm_medium", "toc");
            return u.toString();
          }
        } catch (e) {}
        return url;
      }
      function qrUrl(data) {
        // ონლაინ QR გენერატორი (PNG). ზომა 120x120; EC=H
        // შეგიძლია სხვა სერვისით ჩაანაცვლო (მაგ. api.qrserver.com)
        const enc = encodeURIComponent(data || "");
        return `https://api.qrserver.com/v1/create-qr-code/?size=120x120&ecc=H&data=${enc}`;
      }
      function cardTpl(item) {
        const url = utm(item.url || "#");
        const gh = item.github || "#";
        const qr = qrUrl(url);
        const emailSafe = item.email || "";
        const tags = item.tags || "ვებ";
        const el = document.createElement("article");
        el.className = "card";
        el.dataset.name = item.name || "";
        el.dataset.email = emailSafe;
        el.dataset.github = gh;
        el.innerHTML = `
        <div class="title">
          <span class="name">${item.name || "სახელი"}</span>
          <span class="badge">${tags}</span>
        </div>
        <div class="meta">✉️ ${emailSafe}</div>
        <div class="actions">
          <a class="btn" href="${url}" target="_blank" rel="noopener">ნახე საიტი</a>
          <a class="btn ghost" href="${gh}" target="_blank" rel="noopener">GitHub</a>
        </div>
        <div class="qr">
          <img loading="lazy" src="${qr}" alt="QR კოდი — ${item.name}">
          <small>სკანირე QR და გადადი საიტზე.</small>
        </div>
      `;
        return el;
      }
      function render(data) {
        list.innerHTML = "";
        (data || []).forEach((item) => list.appendChild(cardTpl(item)));
      }

      // სცადე JSON ჩატვირთვა; გათიშვის შემთხვევაში — BUILTIN
      async function boot() {
        try {
          const res = await fetch("./sites.json", { cache: "no-store" });
          if (!res.ok) throw new Error("no json");
          const json = await res.json();
          if (!Array.isArray(json)) throw new Error("bad format");
          render(json);
        } catch (e) {
          render(BUILTIN);
        }
        attachSearchAndExport();
      }

      // ძიება + გასუფთავება + CSV
      function attachSearchAndExport() {
        const q = document.getElementById("q");
        const clear = document.getElementById("clear");
        const cards = [...document.querySelectorAll("#list .card")];

        function filter() {
          const v = (q.value || "").toLowerCase().trim();
          cards.forEach((c) => {
            const hay = (
              c.dataset.name +
              " " +
              c.dataset.email +
              " " +
              c.dataset.github
            ).toLowerCase();
            c.classList.toggle("hidden", v && !hay.includes(v));
          });
        }
        q.addEventListener("input", filter);
        clear.addEventListener("click", () => {
          q.value = "";
          filter();
          q.focus();
        });

        // CSV ექსპორტი — ხილული ბარათები
        document.getElementById("copyCsv").addEventListener("click", () => {
          const rows = [["სახელი", "ელფოსტა", "საიტი", "GitHub"]];
          document.querySelectorAll("#list .card:not(.hidden)").forEach((c) => {
            const name = c.dataset.name || "";
            const email = c.dataset.email || "";
            const url = c.querySelector(".actions a.btn")?.href || "";
            const gh = c.querySelector(".actions a.btn.ghost")?.href || "";
            rows.push([name, email, url, gh]);
          });
          const csv = rows
            .map((r) =>
              r.map((x) => `"${String(x).replaceAll('"', '""')}"`).join(","),
            )
            .join("\n");
          navigator.clipboard
            .writeText(csv)
            .then(() => {
              alert("CSV დაკოპირდა კლიპბორდში.");
            })
            .catch(() => {
              // fallback: ჩამოტვირთვა ფაილად
              const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
              const a = document.createElement("a");
              a.href = URL.createObjectURL(blob);
              a.download = "sites.csv";
              document.body.appendChild(a);
              a.click();
              a.remove();
            });
        });
      }

      boot();
    </script>
  </body>
</html>
